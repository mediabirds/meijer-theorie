import{useApi as e,useStores as t,useCollection as n,defineInterface as r}from"@directus/extensions-sdk";import{ref as i,computed as a,watch as o,defineComponent as l,toRefs as u,inject as s,onMounted as f,resolveComponent as d,resolveDirective as c,openBlock as p,createElementBlock as m,Fragment as g,createBlock as v,mergeProps as y,createSlots as h,withCtx as S,createCommentVNode as E,createElementVNode as A,toDisplayString as b,withDirectives as N,createVNode as T,createTextVNode as x}from"vue";import{useI18n as R}from"vue-i18n";function O(e,t){return(e.match(/{{.*?}}/g)||[]).some((e=>e.includes(t)))}const _=(n,r,l,u,s,f)=>{const d=e(),c=t().useUserStore(),p=i({__currentUser:c.currentUser});let m={},g={};const v=a((()=>JSON.stringify(n.value,((e,t)=>void 0===t?null:t))));return o(v,(async(e,t)=>{var n,i,a;const o=JSON.parse(e),v=void 0!==t?JSON.parse(t):{};if(o.is_homepage&&!o.slug)return;if(!function(e,t,n,r){if("slug"===t&&n.is_homepage&&!n[t])return!1;const i=[];for(const e of Object.keys({...r,...n}))e!==t&&n[e]!==r[e]&&JSON.stringify(n[e])!==JSON.stringify(r[e])&&i.push(e);return!!i.length&&i.some((t=>O(e,t)))}(f,u.value,o,v))return;for(const e of Object.keys(v))e in o||(o[e]=null);let y={};const h=o.id||s.value;for(const e of Object.keys(o)){const t=r.value.find((t=>{var n,r;return[null===(n=t.meta)||void 0===n?void 0:n.one_field,null===(r=t.meta)||void 0===r?void 0:r.many_field].includes(e)}));if(!t||!O(f,e))continue;const u=t.collection===l.value;let s=null!==(a=o[u?null===(n=t.meta)||void 0===n?void 0:n.many_field:null===(i=t.meta)||void 0===i?void 0:i.one_field])&&void 0!==a?a:{create:[],update:[],delete:[]},c=[],p=[];if(u)"number"==typeof s||"string"==typeof s?(s={update:[{id:s}]},"object"==typeof v[e]&&(m={},g={})):"object"==typeof s&&(s="id"in s?{update:[s]}:{create:[{...s}]});else{if(s instanceof Array&&!(v[e]instanceof Array)&&(m={},g={}),"+"!==h){let t;e in m?t=m[e]:(t=(await d.get(`items/${l.value}/${h}`,{params:{fields:[e]}})).data.data[e],m[e]=t),c=c.concat(t)}if(s.update){const e=s.update.map((({id:e})=>e));c=c.filter((t=>!e.includes(t)))}s.delete&&(c=c.filter((e=>!s.delete.includes(e))))}if(s.update&&(c=c.concat(s.update.map((({id:e})=>e)))),c.length){const e=u?t.related_collection:t.collection,n="directus_users"===e?"/users":`items/${e}`;if(e){let t;t=e in g&&c.every((t=>t in g[e]))?c.map((t=>g[e][t])):(await d.get(n,{params:{filter:{id:{_in:c.join(",")}}}})).data.data,p=t.map((t=>{var n;return e in g?g[e][t.id]=t:g[e]={[t.id]:t},{...t,...null===(n=s.update)||void 0===n?void 0:n.find((({id:e})=>t.id===e))}}))}}s.create&&(p=p.concat(s.create)),y[e]=u?p[0]:p}p.value={...o,...y,__currentUser:c.currentUser}}),{deep:!1,immediate:!0}),p},M=(e,t)=>{let n=e;for(const e of t.split(".")){if(!(e in n))return{value:null,found:!1};n=n[e]}return{value:n,found:!0}};function C(e){return"string"==typeof e||e instanceof String}function I(e,t,n={},r=!1){const i=function(e,t,n={},r=!1){var i,a,o,l,u,s,f,d,c,p,m,g,v,y,h,S,E,A,b,N,T;if(t){if((e=e.trim()).startsWith('"')&&e.endsWith('"'))return e.slice(1,-1).replace(/\\"/g,'"');let{value:x,found:R}=M(t,e);if(!R||null===x){let t=M(n,e);if(t.found)return t.value}if(R)return x;if("$NOW"===e)return new Date;if(e.startsWith("$CURRENT_USER"))return"$CURRENT_USER"===e?null===(i=t.__currentUser)||void 0===i?void 0:i.id:M({$CURRENT_USER:t.__currentUser},e).value;const O=function(e){const t=e.trim().match(/^([A-Z_]+)\((.+)\)$/);if(t){const e=[],n=t[1],r=t[2];let i=0,a=0,o=0,l=!1,u=!1;for(;a<r.length;a+=1){const t=r[a];if("("!==t||l)if(")"!==t||l)if(","!==t||l||0!==i)if('"'!==t||u){if("\\"===t&&l){u=!0;continue}}else l=!l;else e.push(r.slice(o,a).trim()),o=a+1;else i-=1;else i+=1;u=!1}return o<a&&e.push(r.slice(o,a).trim()),{op:n,args:e}}return null}(e);if(O){const{op:e,args:i}=O;if(1===i.length){const a=I(i[0],t,n,r);if("INT"===e)return parseInt(a);if("FLOAT"===e)return parseFloat(a);if("STRING"===e)return String(a);if("DATE"===e)return new Date(a);if("SLUG"===e)return function(e){if("string"!=typeof e)return null;let t=e.replace(/^\s+|\s+$/g,"");t=t.toLowerCase();const n="àáãảạăằắẳẵặâầấẩẫậèéẻẽẹêềếểễệđùúủũụưừứửữựòóỏõọôồốổỗộơờớởỡợìíỉĩịäëïîöüûñçýỳỹỵỷşçğöüı",r="aaaaaaaaaaaaaaaaaeeeeeeeeeeeduuuuuuuuuuuoooooooooooooooooiiiiiaeiiouuncyyyyyscgoui";for(let e=0,i=n.length;e<i;e++)t=t.replace(new RegExp(n.charAt(e),"g"),r.charAt(e));return t=t.replace(/[^a-z0-9 -]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-"),t}(a);if("CURRENCY"===e)return(new Intl.NumberFormat).format(a);if("DATE_ISO"===e)return new Date(a).toISOString();if("DATE_UTC"===e)return new Date(a).toUTCString();if("DATE_STR"===e){const e=new Date(a);return`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`}if("TIME_STR"===e){const e=new Date(a);return`${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}:${e.getSeconds().toString().padStart(2,"0")}`}if(["YEAR","MONTH","GET_DATE","DAY","HOURS","MINUTES","SECONDS","TIME"].includes(e)){if(a instanceof Date){return a[{YEAR:"getFullYear",MONTH:"getMonth",GET_DATE:"getDate",DAY:"getDay",HOURS:"getHours",MINUTES:"getMinutes",SECONDS:"getSeconds",TIME:"getTime"}[e]]()}return 0}if("ABS"===e)return Math.abs(a);if("SQRT"===e)return Math.sqrt(a);if("SUM"===e)return a instanceof Array?a.reduce(((e,t)=>e+t),0):0;if("AVERAGE"===e)return a instanceof Array?a.reduce(((e,t)=>e+t),0)/a.length:0;if("CEIL"===e)return Math.ceil(a);if("FLOOR"===e)return Math.floor(a);if("ROUND"===e)return Math.round(a);if("EXP"===e)return Math.exp(a);if("LOG"===e)return Math.log(a);if("MAX"===e)return a instanceof Array?Math.max(...a):0;if("MIN"===e)return a instanceof Array?Math.min(...a):0;if("NULL"===e)return null===a;if("NOT_NULL"===e)return null!==a;if("NOT"===e)return!a;if("STR_LEN"===e)return String(a).length;if("LOWER"===e)return String(a).toLowerCase();if("UPPER"===e)return String(a).toUpperCase();if("TRIM"===e)return String(a).trim();if("ENCODE_URL_COMPONENT"===e)return encodeURIComponent(a);if("ARRAY_LEN"===e)return a instanceof Array?a.length:0;if("LENGTH"===e)return a instanceof Array||C(a)?a.length:null;if("FIRST"===e)return a instanceof Array||C(a)?a[0]:null;if("LAST"===e)return a instanceof Array||C(a)?a[a.length-1]:null;if("REVERSE"===e)return a instanceof Array?a.reverse():C(a)?a.split("").reverse().join(""):null;if("JSON_PARSE"===e)return JSON.parse(a);if("JSON_STRINGIFY"===e)return JSON.stringify(a)}else if(2===i.length){if("ASUM"===e)return null!==(o=null===(a=t[i[0]])||void 0===a?void 0:a.reduce(((e,t)=>e+I(i[1],t,{},r)),0))&&void 0!==o?o:0;if("AMIN"===e)return null!==(u=null===(l=t[i[0]])||void 0===l?void 0:l.reduce(((e,t)=>Math.min(e,I(i[1],t,{},r))),1/0))&&void 0!==u?u:0;if("AMAX"===e)return null!==(f=null===(s=t[i[0]])||void 0===s?void 0:s.reduce(((e,t)=>Math.max(e,I(i[1],t,{},r))),-1/0))&&void 0!==f?f:0;if("AAVG"===e){const e=null!==(d=t[i[0]])&&void 0!==d?d:[];return e.reduce(((e,t)=>e+I(i[1],t,{},r)),0)/e.length}if("AMUL"===e)return null!==(p=null===(c=t[i[0]])||void 0===c?void 0:c.reduce(((e,t)=>e*I(i[1],t,{},r)),1))&&void 0!==p?p:0;if("AAND"===e)return null!==(g=null===(m=t[i[0]])||void 0===m?void 0:m.reduce(((e,t)=>e&&I(i[1],t,{},r)),!0))&&void 0!==g&&g;if("AOR"===e)return null!==(y=null===(v=t[i[0]])||void 0===v?void 0:v.reduce(((e,t)=>e||I(i[1],t,{},r)),!1))&&void 0!==y&&y;if("ACOUNT"===e)return null!==(S=null===(h=t[i[0]])||void 0===h?void 0:h.reduce(((e,t)=>e+(I(i[1],t,{},r)?1:0)),0))&&void 0!==S?S:0;if("MAP"===e)return null!==(A=null===(E=t[i[0]])||void 0===E?void 0:E.map((e=>I(i[1],e,{},r))))&&void 0!==A?A:[];if("FILTER"===e)return null!==(N=null===(b=t[i[0]])||void 0===b?void 0:b.filter((e=>I(i[1],e,{},r))))&&void 0!==N?N:[];if("SORT"===e){const e=null!==(T=t[i[0]])&&void 0!==T?T:[],n=i[1];return[...e].sort(((e,t)=>{const i=I(n,e,{},r),a=I(n,t,{},r);return i<a?-1:i>a?1:0}))}const x=I(i[0],t,n,r),R=I(i[1],t,n,r);if("SUM"===e)return x+R;if("SUBTRACT"===e)return x-R;if("MULTIPLY"===e)return x*R;if("DIVIDE"===e)return x/R;if("REMAINDER"===e)return x%R;if("ROUND"===e)return x.toFixed(R);if("MAX"===e)return Math.max(x,R);if("MIN"===e)return Math.min(x,R);if("POWER"===e)return Math.pow(x,R);if("LEFT"===e)return String(x).slice(0,Number(R));if("RIGHT"===e)return String(x).slice(-Number(R));if("REPT"===e)return String(x).repeat(Number(R));if("JOIN"===e)return x instanceof Array?x.join(String(R)):"";if("SPLIT"===e)return String(x).split(String(R));if("SEARCH"===e){const e=String(x),t=String(R);return e.indexOf(t)}if("EQUAL"===e)return x===R;if("NOT_EQUAL"===e)return x!==R;if("GT"===e)return x>R;if("GTE"===e)return x>=R;if("LT"===e)return x<R;if("LTE"===e)return x<=R;if("AND"===e)return x&&R;if("OR"===e)return x||R;if("CONCAT"===e)return x instanceof Array?x.concat(R):String(x)+String(R);if("AT"===e)return x instanceof Array||C(x)?x[Number(R)]:null;if("INDEX_OF"===e)return x instanceof Array||C(x)?x.indexOf(R):null;if("INCLUDES"===e)return x instanceof Array||C(x)?x.includes(R):null;if("JSON_GET"===e)return"object"!=typeof x||Array.isArray(x)||null===x?null:M(x,R).value}else if(3===i.length){const a=I(i[0],t,n,r),o=I(i[1],t,n,r),l=I(i[2],t,n,r);if("IF"===e)return!0===a?o:l;if("MID"===e){const e=String(a),t=Number(o),n=Number(l);return e.slice(t,t+n)}if("SUBSTITUTE"===e){const e=String(a),t=String(o),n=String(l);return e.split(t).join(n)}if("SEARCH"===e){const e=String(a),t=String(o),n=Number(l);return e.indexOf(t,n)}if("LOCALE_STR"===e){const e=new Date(a),t=String(o);let n={};try{n=JSON.parse(l)}catch(e){}return e.toLocaleString(t,n)}if("RANGE"===e){const e=Number(a),t=Number(o),n=Number(l),r=[];if(n>0)for(let i=e;i<=t;i+=n)r.push(i);else if(n<0)for(let i=e;i>=t;i+=n)r.push(i);return r}if("SLICE"===e){if(a instanceof Array||C(a)){const e=Number(o),t=Number(l);return a.slice(e,t)}return null}}else if(i.length%2==0&&"IFS"===e){for(let e=0;e<i.length;e+=2)if(!0===I(i[e],t,n,r))return I(i[e+1],t,n,r);return null}}if(!isNaN(parseFloat(e)))return parseFloat(e);if(r)throw new Error(`Cannot parse expression: ${e}`)}return""}(e,t,n,r);return r&&console.log(`${e} =`,i),i}var U=l({props:{value:{type:[String,Number],default:""},field:String,type:String,collection:String,primaryKey:[String,Number],template:String,mode:String,prefix:String,suffix:String,customCss:Object,debugMode:Boolean,computeIfEmpty:Boolean,initialCompute:Boolean,disabled:Boolean,placeholder:String,iconLeft:String},emits:["input"],setup(r,{emit:l}){const{t:d}=R(),c=n(r.collection).defaults,p=i(r.value||""),m=(e=>{const{useRelationsStore:n}=t(),{getRelationsForCollection:r}=n();return i(r(e))})(r.collection),g=_(s("values"),m,u(r.collection),u(r.field),u(r.primaryKey),r.template),v=i(null),y=i(!1),h=i(r.prefix||""),S=a((()=>r.suffix||"")),E=a((()=>{const e=p.value?p.value.toString():"";if(!e)return"";const t=h.value+e;return t.startsWith("http://")||t.startsWith("https://")?t:`https://${t}`}));return f((async()=>{try{const t=await async function(t,n){var r,i;const a=e();try{return(null===(i=null===(r=(await a.get(`/items/${t}/${n}`)).data)||void 0===r?void 0:r.data)||void 0===i?void 0:i.prefix)||""}catch(e){return console.error("Error fetching prefix:",e),""}}(r.collection,r.primaryKey);h.value=t||r.prefix||""}catch(e){console.error("Failed to fetch prefix:",e),h.value=r.prefix||""}})),o((()=>h.value),(async t=>{try{await async function(t,n,r){const i=e();try{await i.patch(`/items/${t}/${n}`,{prefix:r})}catch(e){throw console.error("Error saving prefix:",e),e}}(r.collection,r.primaryKey,t)}catch(e){console.error("Failed to save prefix:",e)}})),o((()=>r.value),(e=>{p.value=e})),f((()=>{p.value=r.value||"",y.value=!!r.value})),{t:d,computedValue:p,errorMsg:v,isEditing:y,renderedPrefix:h,renderedSuffix:S,fullLink:E,enableEdit:function(){y.value=!0},disableEdit:function(){y.value=!1,l("input",p.value||r.value)},computeAndEmitValue:function(){const e=function(){try{const e=r.template.replace(/{{.*?}}/g,(e=>I(e.slice(2,-2).trim(),g.value,c.value,r.debugMode)));return v.value=null,["integer","decimal","bigInteger"].includes(r.type)?parseInt(e)||0:"float"===r.type?parseFloat(e)||0:e||""}catch(e){return v.value=e.message||"Error computing value",""}}();p.value=e,l("input",e||r.value)},onChange:function(e){p.value=e||""}}}});const w={class:"prefixsuffix"},L={class:"prefixsuffix"},D={key:1,class:"link-preview-mode"},k=["href"],$={class:"action-buttons"};var F=[],P=[];!function(e,t){if(e&&"undefined"!=typeof document){var n,r=!0===t.prepend?"prepend":"append",i=!0===t.singleTag,a="string"==typeof t.container?document.querySelector(t.container):document.getElementsByTagName("head")[0];if(i){var o=F.indexOf(a);-1===o&&(o=F.push(a)-1,P[o]={}),n=P[o]&&P[o][r]?P[o][r]:P[o][r]=l()}else n=l();65279===e.charCodeAt(0)&&(e=e.substring(1)),n.styleSheet?n.styleSheet.cssText+=e:n.appendChild(document.createTextNode(e))}function l(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),t.attributes)for(var n=Object.keys(t.attributes),i=0;i<n.length;i++)e.setAttribute(n[i],t.attributes[n[i]]);var o="prepend"===r?"afterbegin":"beforeend";return a.insertAdjacentElement(o,e),e}}("\n.link-preview-mode[data-v-64969d30] {\r\n  display: flex;\r\n  align-items: center;\r\n  min-height: var(--input-height);\n}\n.icon-left[data-v-64969d30] {\r\n  margin-right: 8px;\n}\n.prefixsuffix[data-v-64969d30] {\r\n  color: var(--foreground-subdued);\n}\n.link[data-v-64969d30] {\r\n  color: var(--foreground-subdued);\r\n  text-decoration: underline;\r\n  word-break: break-word;\n}\n.action-buttons[data-v-64969d30] {\r\n  display: flex;\r\n  align-items: center;\r\n  margin-left: 8px;\n}\n.action-button[data-v-64969d30] {\r\n  margin-right: 8px;\n}\n.genbutton[data-v-64969d30] {\r\n  display: flex;\r\n  align-items: center;\r\n  cursor: pointer;\n}\na.link[data-v-64969d30] {\r\n  color: var(--primary);\n}\na.link[data-v-64969d30]:hover {\r\n  color: var(--primary-75);\n}\r\n",{}),U.render=function(e,t,n,r,i,a){const o=d("v-icon"),l=d("v-input"),u=d("v-button"),s=d("v-notice"),f=c("tooltip");return p(),m(g,null,[e.isEditing&&!e.disabled?(p(),v(l,y({key:0},e.$attrs,{field:e.field,collection:e.collection,"primary-key":e.primaryKey,"model-value":e.computedValue,autofocus:!0,placeholder:e.placeholder,"onUpdate:modelValue":e.onChange,onBlur:e.disableEdit}),h({_:2},[e.iconLeft||e.renderedPrefix?{name:"prepend",fn:S((()=>[e.iconLeft?(p(),v(o,{key:0,name:e.iconLeft},null,8,["name"])):E("v-if",!0),A("span",w,b(e.renderedPrefix),1)])),key:"0"}:void 0,e.renderedSuffix?{name:"append",fn:S((()=>[A("span",L,b(e.renderedSuffix),1)])),key:"1"}:void 0]),1040,["field","collection","primary-key","model-value","placeholder","onUpdate:modelValue","onBlur"])):(p(),m("div",D,[e.iconLeft?(p(),v(o,{key:0,name:e.iconLeft,class:"icon-left"},null,8,["name"])):E("v-if",!0),e.computedValue?(p(),m("a",{key:1,href:e.fullLink,target:"_blank",class:"link"},b(e.renderedPrefix+e.computedValue+e.renderedSuffix),9,k)):(p(),m("span",{key:2,class:"link",onClick:t[0]||(t[0]=t=>!e.disabled&&e.enableEdit)},b(e.renderedPrefix+(e.computedValue?e.computedValue:e.placeholder||"")+e.renderedSuffix),1)),A("div",$,[e.disabled?E("v-if",!0):N((p(),v(u,{key:0,"x-small":"",secondary:"",icon:"",class:"action-button",onClick:e.enableEdit},{default:S((()=>[T(o,{name:"edit"})])),_:1},8,["onClick"])),[[f,e.t("edit")]]),N((p(),v(u,{"x-small":"",secondary:"",icon:"",class:"genbutton",onClick:e.computeAndEmitValue},{default:S((()=>[T(o,{name:"auto_fix_high"})])),_:1},8,["onClick"])),[[f,e.t("auto_generate")]])])])),e.errorMsg?(p(),v(s,{key:2,type:"danger"},{default:S((()=>[x(b(e.errorMsg),1)])),_:1})):E("v-if",!0)],64)},U.__scopeId="data-v-64969d30",U.__file="src/interface.vue";var j=r({id:"computed",name:"Auto Gen",icon:"calculate",description:"Perform auto generated values depended on your needs.",component:U,types:["string","text","integer","decimal","bigInteger","float","boolean","alias"],group:"other",options:[{field:"template",name:"Template",type:"string",meta:{width:"full",interface:"input"}},{field:"mode",name:"Field Mode",type:"string",meta:{width:"full",interface:"select-dropdown",options:{allowNone:!0,choices:[{text:"Display Only",value:"displayonly"},{text:"Read Only",value:"readonly"}]}}},{field:"prefix",name:"Prefix",type:"string",meta:{width:"half",interface:"system-input-translated-string",options:{trim:!1}}},{field:"suffix",name:"Suffix",type:"string",meta:{width:"half",interface:"system-input-translated-string",options:{trim:!1}}},{field:"customCss",name:"Custom CSS",type:"json",meta:{width:"full",interface:"input-code",options:{language:"json"}}},{field:"debugMode",name:"Debug Mode",type:"boolean",meta:{width:"full",interface:"boolean",note:"Used for debugging the template. It will show an error message if the template is invalid. It will also log to console the result of each component of the template."}},{field:"computeIfEmpty",name:"Compute If Empty",type:"boolean",meta:{width:"full",interface:"boolean",note:"Compute the value if the field is empty. This is useful if you want a value to be computed once such as the created date or a unique ID."}},{field:"initialCompute",name:"Initial Compute",type:"boolean",meta:{width:"full",interface:"boolean",note:"Compute the value when opening the form. This is useful if you want to compute a value based on the current date or other dynamic values."}}]});export{j as default};
